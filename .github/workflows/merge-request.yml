# This workflow orchestrates the Continuous Integration and Continuous Delivery (CI/CD)
# for Terraform and Packer using GitHub Actions and Semantic Release.
name: Terraform & Automation CI/CD
on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

# Define environment variables used throughout the workflow
env:
  TF_WORKING_DIR: ./terraform  # Path to Terraform configuration files
  PKR_WORKING_DIR: ./packer/centos    # Path to Packer template files
  ANSIBLE_WORKING_DIR: ./ansible # Path to Ansible playbooks/roles
  AWS_REGION: us-east-1          # Default AWS region

jobs:

  ###################################################################################
  # JOB 1: VALIDATION AND LINTING (Runs on Pull Request events)
  ###################################################################################
  lint_validate_docs:
    name: Validate (PR Check)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v6
      
    - name: Set up AWS credentials (required for some Terraform validation)
      uses: aws-actions/configure-aws-credentials@v5
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # -------------------------------------------------------------------------------
    # 1. TERRAFORM CHECKS (Pull Request)
    # -------------------------------------------------------------------------------
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.13.x

    - name: Terraform Init (Validation prerequisite)
      id: init_tf
      run: terraform init -upgrade -backend=false
      working-directory: ${{ env.TF_WORKING_DIR }}
      
    - name: Terraform Format Check (fmt)
      id: fmt_tf
      run: terraform fmt -check -recursive
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Terraform Validate
      id: validate_tf
      run: terraform validate
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Run TFLint
      uses: terraform-linters/setup-tflint@v6
      with:
        working_directory: ${{ env.TF_WORKING_DIR }}
        
    - name: Generate Terraform Docs
      uses: terraform-docs/gh-actions@v1
      with:
        working-dir: ${{ env.TF_WORKING_DIR }}
        output-file: README.md
        output-method: inject
        
    # -------------------------------------------------------------------------------
    # 2. ANSIBLE CHECKS (Pull Request)
    # -------------------------------------------------------------------------------
    - name: Run Ansible Lint
      uses: ansible/ansible-lint@v25 # Use the dedicated action for linting
      with:
        working_directory: ${{ env.ANSIBLE_WORKING_DIR }}

    # -------------------------------------------------------------------------------
    # 3. PACKER CHECKS (Pull Request)
    # -------------------------------------------------------------------------------
    - name: Setup Packer
      uses: hashicorp/setup-packer@v3
      
    - name: Packer Init
      id: init_packer
      run: find . -type f -name "*.pkr.hcl" -print0 | xargs -0 -I {} packer init "{}"
      working-directory: ${{ env.PKR_WORKING_DIR }}
      
    - name: Packer Validate
      id: validate_packer
      run: find ${{ env.PKR_WORKING_DIR }} -type f -name "*.pkr.hcl" -print0 | xargs -0 -I {} packer validate "{}"
      